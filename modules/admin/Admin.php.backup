<?php
/**
 * Admin ModÃ¼lÃ¼
 */

if (!defined('ABSPATH')) {
    exit;
}

class Dastas_Admin {
    
    private $db;
    
    public function __construct() {
        $this->db = Dastas_Plugin::getInstance()->getModule('database');
        add_action('admin_menu', array($this, 'addAdminMenu'));
        add_action('admin_enqueue_scripts', array($this, 'enqueueAdminScripts'));
        
        // AJAX handlers for admin
        add_action('wp_ajax_dastas_admin_action', array($this, 'handleAdminAction'));
        add_action('wp_ajax_dastas_export_orders', array($this, 'handleExportOrders'));
        add_action('wp_ajax_dastas_update_order_status', array($this, 'handleUpdateOrderStatus'));
        add_action('wp_ajax_dastas_get_admin_order_details', array($this, 'handleGetAdminOrderDetails'));
    }
    
    public function addAdminMenu() {
        add_menu_page(
            'Dastas Bayi Sistemi',
            'Dastas Bayi',
            'manage_options',
            'dastas-bayi',
            array($this, 'renderMainPage'),
            'dashicons-store',
            30
        );
        
        add_submenu_page(
            'dastas-bayi',
            'SipariÅŸler',
            'SipariÅŸler',
            'manage_options',
            'dastas-siparisler',
            array($this, 'renderOrdersPage')
        );
        
        add_submenu_page(
            'dastas-bayi',
            'Bayiler',
            'Bayiler',
            'manage_options',
            'dastas-bayiler',
            array($this, 'renderBayilerPage')
        );
        
        add_submenu_page(
            'dastas-bayi',
            'Bildirimler',
            'Bildirimler',
            'manage_options',
            'dastas-bildirimler',
            array($this, 'renderNotificationsPage')
        );
        
        add_submenu_page(
            'dastas-bayi',
            'Ayarlar',
            'Ayarlar',
            'manage_options',
            'dastas-ayarlar',
            array($this, 'renderSettingsPage')
        );
    }
    
    public function enqueueAdminScripts($hook) {
        if (strpos($hook, 'dastas') !== false) {
            wp_enqueue_script('dastas-admin-js', plugin_dir_url(__FILE__) . '../../assets/admin.js', array('jquery'), '1.0.0', true);
            wp_enqueue_style('dastas-admin-css', plugin_dir_url(__FILE__) . '../../assets/dastas-admin.css', array(), '1.0.0');
            
            // Admin panel stilleri
            wp_enqueue_style('dastas-admin-panel-css', plugin_dir_url(__FILE__) . '../../assets/dastas-admin-panel.css', array(), '1.0.0');
            
            // Orders table CSS
            wp_enqueue_style('admin-orders-table-css', plugin_dir_url(__FILE__) . '../../assets/admin-orders-table.css', array(), '1.0.0');
            
            // Chart.js for analytics - sadece analytics sayfasÄ±nda
            if (strpos($hook, 'dastas-analytics') !== false || isset($_GET['page']) && $_GET['page'] === 'dastas-analytics') {
                wp_enqueue_script('chart-js', 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js', array(), '3.9.1', true);
                wp_enqueue_style('dastas-analytics-css', plugin_dir_url(__FILE__) . '../../assets/dastas-analytics.css', array(), '1.0.0');
            }
            
            wp_localize_script('dastas-admin-js', 'dastas_admin_ajax', array(
                'ajax_url' => admin_url('admin-ajax.php'),
                'nonce' => wp_create_nonce('dastas_admin_nonce'),
            ));
        }
    }
    
    public function renderMainPage() {
        $stats = $this->getSystemStats();
        $detailed_stats = $this->getDetailedStats();
        ?>
        <div class="wrap">
            <div class="dastas-admin-header">
                <div class="header-content">
                    <div class="welcome-section">
                        <h1>ğŸª Dastas Bayi Sistemi - Genel BakÄ±ÅŸ</h1>
                        <p class="header-subtitle">Sistemin genel durumu ve Ã¶nemli metrikler</p>
                    </div>
                    <div class="header-actions">
                        <button class="button button-primary" onclick="refreshDashboard()">ğŸ”„ Yenile</button>
                        <button class="button button-secondary" onclick="exportReport()">ğŸ“Š Rapor Al</button>
                    </div>
                </div>
            </div>

            <!-- Enhanced Statistics Cards -->
            <div class="dastas-admin-stats-grid">
                <div class="stat-card primary">
                    <div class="stat-icon">ğŸ‘¥</div>
                    <div class="stat-content">
                        <h3><?php echo number_format($stats['toplam_bayi']); ?></h3>
                        <p>Toplam Bayi</p>
                        <div class="stat-trend trend-up">
                            <span class="trend-icon">â†—ï¸</span>
                            <span class="trend-text">+%<?php echo $detailed_stats['bayi_artis_orani']; ?> bu ay</span>
                        </div>
                    </div>
                    <div class="stat-badge"><?php echo $stats['aktif_bayi']; ?> aktif</div>
                </div>

                <div class="stat-card warning">
                    <div class="stat-icon">â³</div>
                    <div class="stat-content">
                        <h3><?php echo number_format($stats['bekleyen_siparis']); ?></h3>
                        <p>Bekleyen SipariÅŸ</p>
                        <div class="stat-trend trend-stable">
                            <span class="trend-icon">â¡ï¸</span>
                            <span class="trend-text">Ortalama <?php echo $detailed_stats['ortalama_bekleme']; ?> gÃ¼n</span>
                        </div>
                    </div>
                    <div class="stat-badge priority-<?php echo $detailed_stats['bekleyen_oncelik']; ?>">
                        <?php echo $detailed_stats['bekleyen_oncelik'] === 'high' ? 'âš ï¸ YÃ¼ksek' : 'âœ… Normal'; ?>
                    </div>
                </div>

                <div class="stat-card success">
                    <div class="stat-icon">âœ…</div>
                    <div class="stat-content">
                        <h3><?php echo number_format($detailed_stats['tamamlanan_siparis']); ?></h3>
                        <p>Tamamlanan SipariÅŸ</p>
                        <div class="stat-trend trend-up">
                            <span class="trend-icon">ğŸ“ˆ</span>
                            <span class="trend-text">+%<?php echo $detailed_stats['tamamlanma_orani']; ?> baÅŸarÄ±</span>
                        </div>
                    </div>
                    <div class="stat-badge">Bu hafta</div>
                </div>

                <div class="stat-card info">
                    <div class="stat-icon">ğŸ“¦</div>
                    <div class="stat-content">
                        <h3><?php echo number_format($stats['toplam_siparis']); ?></h3>
                        <p>Toplam SipariÅŸ</p>
                        <div class="stat-trend trend-up">
                            <span class="trend-icon">ğŸ”¥</span>
                            <span class="trend-text"><?php echo number_format($detailed_stats['bugunku_siparis']); ?> bugÃ¼n</span>
                        </div>
                    </div>
                    <div class="stat-badge"><?php echo number_format($detailed_stats['toplam_m3'], 1); ?> mÂ³</div>
                </div>
            </div>

            <!-- Enhanced Widgets Grid -->
            <div class="dastas-admin-widgets-grid">
                <!-- Recent Orders Widget -->
                <div class="widget-card enhanced">
                    <div class="widget-header">
                        <h3>ğŸ“‹ Son SipariÅŸler</h3>
                        <div class="widget-actions">
                            <select class="order-type-filter" onchange="filterOrdersByType(this.value)">
                                <option value="all">TÃ¼mÃ¼</option>
                                <option value="beklemede">Bekleyen</option>
                                <option value="onaylandi">Onaylanan</option>
                                <option value="teslim-edildi">Teslim Edilen</option>
                            </select>
                            <a href="<?php echo admin_url('admin.php?page=dastas-siparisler'); ?>" class="view-all-btn">TÃ¼mÃ¼nÃ¼ GÃ¶r â†’</a>
                        </div>
                    </div>
                    <div class="widget-content">
                        <div class="orders-list">
                            <?php $this->renderEnhancedRecentOrders(); ?>
                        </div>
                    </div>
                </div>

                <!-- System Status Widget -->
                <div class="widget-card enhanced">
                    <div class="widget-header">
                        <h3>ğŸ”§ Sistem Durumu</h3>
                        <div class="status-indicator status-<?php echo $detailed_stats['sistem_sagligi']; ?>">
                            <?php echo $detailed_stats['sistem_sagligi'] === 'excellent' ? 'ğŸŸ¢ MÃ¼kemmel' : 'ğŸŸ¡ Ä°yi'; ?>
                        </div>
                    </div>
                    <div class="widget-content">
                        <div class="system-status-detailed">
                            <?php $this->renderDetailedSystemStatus(); ?>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Widget -->
                <div class="widget-card enhanced">
                    <div class="widget-header">
                        <h3>âš¡ HÄ±zlÄ± Ä°ÅŸlemler</h3>
                    </div>
                    <div class="widget-content">
                        <div class="quick-actions-grid">
                            <button class="quick-action-btn primary" onclick="bulkApproveOrders()">
                                <span class="action-icon">âœ…</span>
                                <span class="action-text">Toplu Onay</span>
                                <span class="action-desc">Bekleyen sipariÅŸleri onayla</span>
                            </button>

                            <button class="quick-action-btn warning" onclick="sendNotification()">
                                <span class="action-icon">ğŸ“¢</span>
                                <span class="action-text">Bildirim GÃ¶nder</span>
                                <span class="action-desc">TÃ¼m bayilere duyuru</span>
                            </button>

                            <button class="quick-action-btn info" onclick="exportData()">
                                <span class="action-icon">ğŸ“Š</span>
                                <span class="action-text">Veri AktarÄ±mÄ±</span>
                                <span class="action-desc">Excel/CSV export</span>
                            </button>

                            <button class="quick-action-btn secondary" onclick="systemMaintenance()">
                                <span class="action-icon">ğŸ”§</span>
                                <span class="action-text">BakÄ±m Modu</span>
                                <span class="action-desc">Sistem optimizasyonu</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Performance Metrics Widget -->
                <div class="widget-card enhanced">
                    <div class="widget-header">
                        <h3>ğŸ“ˆ Performans Metrikleri</h3>
                    </div>
                    <div class="widget-content">
                        <div class="metrics-grid">
                            <div class="metric-item">
                                <span class="metric-label">Ortalama Ä°ÅŸlem SÃ¼resi:</span>
                                <span class="metric-value"><?php echo $detailed_stats['ortalama_islem_suresi']; ?> gÃ¼n</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">AylÄ±k BÃ¼yÃ¼me:</span>
                                <span class="metric-value positive">+%<?php echo $detailed_stats['aylik_buyume']; ?></span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Aktif KullanÄ±cÄ±:</span>
                                <span class="metric-value"><?php echo $detailed_stats['aktif_kullanici']; ?>%</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Sistem YÃ¼kÃ¼:</span>
                                <span class="metric-value load-<?php echo $detailed_stats['sistem_yuku']; ?>"><?php echo $detailed_stats['sistem_yuku']; ?>%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tips and Tricks Section -->
            <div class="tips-tricks-section">
                <div class="section-header">
                    <h3>ğŸ’¡ Ä°puÃ§larÄ± ve PÃ¼f NoktalarÄ±</h3>
                </div>
                <div class="tips-grid">
                    <div class="tip-card">
                        <div class="tip-icon">âš¡</div>
                        <div class="tip-content">
                            <h4>HÄ±zlÄ± Toplu Ä°ÅŸlemler</h4>
                            <p>SipariÅŸler sayfasÄ±nda checkbox ile birden fazla sipariÅŸi seÃ§ip toplu iÅŸlem yapabilirsiniz.</p>
                        </div>
                    </div>

                    <div class="tip-card">
                        <div class="tip-icon">ğŸ”</div>
                        <div class="tip-content">
                            <h4>Filtreleme Sistemi</h4>
                            <p>Bayi koduna gÃ¶re arama yapmak iÃ§in arama kutusunu kullanÄ±n. BÃ¼yÃ¼k kÃ¼Ã§Ã¼k harf duyarlÄ±dÄ±r.</p>
                        </div>
                    </div>

                    <div class="tip-card">
                        <div class="tip-icon">ğŸ“Š</div>
                        <div class="tip-content">
                            <h4>Raporlama</h4>
                            <p>Excel export Ã¶zelliÄŸi ile detaylÄ± raporlar alabilir, grafik analizleri inceleyebilirsiniz.</p>
                        </div>
                    </div>

                    <div class="tip-card">
                        <div class="tip-icon">ğŸ””</div>
                        <div class="tip-content">
                            <h4>Bildirim YÃ¶netimi</h4>
                            <p>Otomatik bildirim ayarlarÄ±nÄ± Ayarlar bÃ¶lÃ¼mÃ¼nden yapÄ±landÄ±rabilirsiniz.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
        function refreshDashboard() {
            location.reload();
        }

        function exportReport() {
            alert('Raporlama Ã¶zelliÄŸi yakÄ±nda eklenecek!');
        }

        function filterOrdersByType(type) {
            // SipariÅŸ filtreleme iÅŸlemi
            console.log('Filtering orders by type:', type);
        }

        function bulkApproveOrders() {
            window.location.href = '<?php echo admin_url('admin.php?page=dastas-siparisler'); ?>';
        }

        function sendNotification() {
            window.location.href = '<?php echo admin_url('admin.php?page=dastas-bildirimler'); ?>';
        }

        function exportData() {
            alert('Veri export Ã¶zelliÄŸi iÃ§in SipariÅŸler sayfasÄ±na gidin!');
        }

        function systemMaintenance() {
            alert('BakÄ±m modu aktifleÅŸtirildi!');
        }
        </script>
        <?php
    }
    
    public function renderOrdersPage() {
        $orders = $this->getOrders();
        ?>
        <div class="wrap">
            <div class="dastas-page-header">
                <h1>ğŸ“¦ SipariÅŸler YÃ¶netimi</h1>
                <div class="header-actions">
                    <button class="button button-secondary" onclick="refreshOrdersList()">ğŸ”„ Yenile</button>
                    <button class="button button-primary" id="export-orders">ğŸ“Š Excel'e Aktar</button>
                </div>
            </div>

            <!-- Enhanced Filters -->
            <div class="orders-filters">
                <div class="filter-group">
                    <label>ğŸ“… Tarih AralÄ±ÄŸÄ±:</label>
                    <input type="date" id="date-from" class="filter-input">
                    <span>-</span>
                    <input type="date" id="date-to" class="filter-input">
                </div>
                
                <div class="filter-group">
                    <label>ğŸ‘¤ Bayi:</label>
                    <input type="text" id="bayi-filter" placeholder="Bayi adÄ± veya kodu..." class="filter-input">
                </div>
                
                <div class="filter-group">
                    <label>ğŸ“‹ Durum:</label>
                    <select id="status-filter" class="filter-input">
                        <option value="">TÃ¼m Durumlar</option>
                        <option value="beklemede">Beklemede</option>
                        <option value="onaylandi">OnaylandÄ±</option>
                        <option value="hazirlaniyor">HazÄ±rlanÄ±yor</option>
                        <option value="sevk-edildi">Sevk Edildi</option>
                        <option value="teslim-edildi">Teslim Edildi</option>
                        <option value="iptal">Ä°ptal</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <button class="button" onclick="applyFilters()">ğŸ” Filtrele</button>
                    <button class="button" onclick="clearFilters()">ğŸ—‘ï¸ Temizle</button>
                </div>
            </div>

            <!-- Top Navigation - Enhanced -->
            <div class="tablenav top enhanced-tablenav">
                <div class="alignleft actions">
                    <select id="bulk-action-selector-top" class="enhanced-select">
                        <option value="-1">Toplu Ä°ÅŸlemler</option>
                        <option value="approve">âœ… Onayla</option>
                        <option value="prepare">ğŸ”¨ HazÄ±rlanÄ±yor</option>
                        <option value="shipped">ğŸšš Sevk Edildi</option>
                        <option value="delivered">ğŸ“¦ Teslim Edildi</option>
                        <option value="cancel">âŒ Ä°ptal Et</option>
                    </select>
                    <button class="button action enhanced-btn" id="doaction">Uygula</button>
                    
                    <span class="bulk-info" id="bulk-info" style="display: none;">
                        <span id="selected-count">0</span> sipariÅŸ seÃ§ildi
                    </span>
                </div>

                <div class="alignright actions">
                    <div class="orders-summary">
                        <span class="summary-item">
                            <strong><?php echo count($orders); ?></strong> sipariÅŸ
                        </span>
                        <span class="summary-item">
                            <strong><?php echo number_format(array_sum(array_column($orders, 'toplam_m3')), 1); ?></strong> mÂ³
                        </span>
                    </div>
                </div>
            </div>

            <!-- Enhanced Orders Table -->
            <div class="orders-table-container">
                <table class="wp-list-table widefat fixed striped enhanced-orders-table">
                    <thead>
                        <tr>
                            <td class="manage-column column-cb check-column">
                                <input type="checkbox" id="cb-select-all-1">
                            </td>
                            <th class="column-siparis-no sortable" data-sort="siparis_no">
                                <span>SipariÅŸ No</span>
                                <span class="sort-icon">â†•ï¸</span>
                            </th>
                            <th class="column-bayi sortable" data-sort="bayi_adi">
                                <span>Bayi</span>
                                <span class="sort-icon">â†•ï¸</span>
                            </th>
                            <th class="column-tarih sortable" data-sort="siparis_tarihi">
                                <span>Tarih</span>
                                <span class="sort-icon">â†•ï¸</span>
                            </th>
                            <th class="column-urun-sayisi">ÃœrÃ¼n SayÄ±sÄ±</th>
                            <th class="column-m3 sortable" data-sort="toplam_m3">
                                <span>Toplam mÂ³</span>
                                <span class="sort-icon">â†•ï¸</span>
                            </th>
                            <th class="column-durum">Durum</th>
                            <th class="column-actions">Ä°ÅŸlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($orders as $order): ?>
                            <?php 
                            $days_pending = floor((time() - strtotime($order->siparis_tarihi)) / (60*60*24));
                            $priority_class = '';
                            if ($order->durum === 'beklemede' && $days_pending > 7) {
                                $priority_class = 'priority-high';
                            } elseif ($order->durum === 'beklemede' && $days_pending > 3) {
                                $priority_class = 'priority-medium';
                            }
                            ?>
                            <tr class="order-row <?php echo $priority_class; ?>" data-order-id="<?php echo $order->id; ?>" data-status="<?php echo $order->durum; ?>">
                                <th class="check-column">
                                    <input type="checkbox" name="order[]" value="<?php echo $order->id; ?>" class="order-checkbox">
                                </th>
                                <td class="column-siparis-no">
                                    <strong class="siparis-no"><?php echo esc_html($order->siparis_no); ?></strong>
                                    <?php if ($days_pending > 7 && $order->durum === 'beklemede'): ?>
                                        <span class="urgent-badge" title="<?php echo $days_pending; ?> gÃ¼ndÃ¼r bekliyor">ğŸš¨</span>
                                    <?php endif; ?>
                                </td>
                                <td class="column-bayi">
                                    <div class="bayi-info">
                                        <strong><?php echo esc_html($order->bayi_adi); ?></strong>
                                        <div class="bayi-details">
                                            <span class="order-time"><?php echo date('H:i', strtotime($order->siparis_tarihi)); ?></span>
                                        </div>
                                    </div>
                                </td>
                                <td class="column-tarih">
                                    <div class="date-info">
                                        <strong><?php echo date('d.m.Y', strtotime($order->siparis_tarihi)); ?></strong>
                                        <div class="date-details">
                                            <?php 
                                            if ($days_pending == 0) {
                                                echo 'BugÃ¼n';
                                            } elseif ($days_pending == 1) {
                                                echo 'DÃ¼n';
                                            } else {
                                                echo $days_pending . ' gÃ¼n Ã¶nce';
                                            }
                                            ?>
                                        </div>
                                    </div>
                                </td>
                                <td class="column-urun-sayisi">
                                    <span class="urun-badge"><?php echo $order->urun_sayisi; ?> Ã¼rÃ¼n</span>
                                </td>
                                <td class="column-m3">
                                    <span class="m3-value"><?php echo number_format($order->toplam_m3, 2); ?> mÂ³</span>
                                </td>
                                <td class="column-durum">
                                    <div class="status-dropdown-container">
                                        <select class="order-status-select enhanced-status-select" data-order-id="<?php echo $order->id; ?>" data-original="<?php echo $order->durum; ?>">
                                            <option value="beklemede" <?php selected($order->durum, 'beklemede'); ?>>â³ Beklemede</option>
                                            <option value="onaylandi" <?php selected($order->durum, 'onaylandi'); ?>>âœ… OnaylandÄ±</option>
                                            <option value="hazirlaniyor" <?php selected($order->durum, 'hazirlaniyor'); ?>>ğŸ”¨ HazÄ±rlanÄ±yor</option>
                                            <option value="sevk-edildi" <?php selected($order->durum, 'sevk-edildi'); ?>>ğŸšš Sevk Edildi</option>
                                            <option value="teslim-edildi" <?php selected($order->durum, 'teslim-edildi'); ?>>ğŸ“¦ Teslim Edildi</option>
                                            <option value="iptal" <?php selected($order->durum, 'iptal'); ?>>âŒ Ä°ptal</option>
                                        </select>
                                        <div class="status-indicator status-<?php echo $order->durum; ?>"></div>
                                    </div>
                                </td>
                                <td class="column-actions">
                                    <div class="action-buttons">
                                        <button class="button button-small action-btn view-order-btn" 
                                                data-order-id="<?php echo $order->id; ?>" 
                                                data-siparis-no="<?php echo esc_attr($order->siparis_no); ?>"
                                                title="DetaylarÄ± GÃ¶rÃ¼ntÃ¼le">
                                            ğŸ‘ï¸ Detay
                                        </button>
                                        
                                        <div class="action-dropdown">
                                            <button class="button button-small action-btn dropdown-toggle" 
                                                    onclick="toggleActionDropdown(this)"
                                                    title="Daha fazla iÅŸlem">
                                                â‹®
                                            </button>
                                            <div class="dropdown-menu">
                                                <a href="#" onclick="duplicateOrder(<?php echo $order->id; ?>)">ğŸ“‹ Kopyala</a>
                                                <a href="#" onclick="printOrder(<?php echo $order->id; ?>)">ğŸ–¨ï¸ YazdÄ±r</a>
                                                <a href="#" onclick="sendNotification(<?php echo $order->id; ?>)">ğŸ“§ Bildirim GÃ¶nder</a>
                                                <div class="dropdown-divider"></div>
                                                <a href="#" onclick="deleteOrder(<?php echo $order->id; ?>)" class="delete-action">ğŸ—‘ï¸ Sil</a>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>

            <?php if (empty($orders)): ?>
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“¦</div>
                    <h3>HenÃ¼z sipariÅŸ bulunmuyor</h3>
                    <p>Yeni sipariÅŸler geldiÄŸinde burada gÃ¶rÃ¼necekler.</p>
                    <button class="button button-primary" onclick="refreshOrdersList()">ğŸ”„ Yenile</button>
                </div>
            <?php endif; ?>
        </div>

        <link rel="stylesheet" href="<?php echo plugin_dir_url(__FILE__); ?>/admin.css" type="text/css" media="all" />

        <!-- SipariÅŸ Detay Modal -->
        <div id="admin-order-detail-modal" class="dastas-admin-modal" style="display: none;">
            <div class="modal-overlay" onclick="closeOrderDetailModal()"></div>
            <div class="modal-container">
                <div class="modal-header">
                    <h3>ğŸ“‹ SipariÅŸ DetaylarÄ±</h3>
                    <button class="modal-close" onclick="closeOrderDetailModal()">
                        <span class="dashicons dashicons-no"></span>
                    </button>
                </div>
                <div class="modal-body" id="admin-order-detail-content">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p>SipariÅŸ detaylarÄ± yÃ¼kleniyor...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="button" onclick="closeOrderDetailModal()">Kapat</button>
                    <button class="button button-primary" onclick="printOrderDetails()">ğŸ–¨ï¸ YazdÄ±r</button>
                </div>
            </div>
        </div>

        <link rel="stylesheet" href="<?php echo plugin_dir_url(__FILE__); ?>/admin.css" type="text/css" media="all" />

        <script src="<?php echo plugin_dir_url(__FILE__); ?>/admin.js"></script>
        <?php
    }
    
    public function renderBayilerPage() {
        $bayiler = $this->db->getBayiler();
        ?>
        <div class="wrap">
            <h1>Bayiler 
                <button class="page-title-action" id="add-new-bayi">Yeni Bayi Ekle</button>
            </h1>
            
            <table class="wp-list-table widefat fixed striped">
                <thead>
                    <tr>
                        <th>Bayi Kodu</th>
                        <th>Bayi AdÄ±</th>
                        <th>KullanÄ±cÄ± AdÄ±</th>
                        <th>Telefon</th>
                        <th>E-posta</th>
                        <th>Durum</th>
                        <th>KayÄ±t Tarihi</th>
                        <th>Ä°ÅŸlemler</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($bayiler as $bayi): ?>
                        <tr>
                            <td><strong><?php echo esc_html($bayi->bayi_kodu); ?></strong></td>
                            <td><?php echo esc_html($bayi->bayi_adi); ?></td>
                            <td><?php echo esc_html($bayi->kullanici_adi); ?></td>
                            <td><?php echo esc_html($bayi->telefon); ?></td>
                            <td><?php echo esc_html($bayi->eposta); ?></td>
                            <td>
                                <span class="status-badge status-<?php echo $bayi->aktif ? 'active' : 'inactive'; ?>">
                                    <?php echo $bayi->aktif ? 'Aktif' : 'Pasif'; ?>
                                </span>
                            </td>
                            <td><?php echo $bayi->olusturma_tarihi ? date('d.m.Y H:i', strtotime($bayi->olusturma_tarihi)) : '-'; ?></td>
                            <td>
                                <button class="button button-small edit-bayi" data-bayi-id="<?php echo $bayi->id; ?>">DÃ¼zenle</button>
                                <?php if ($bayi->aktif): ?>
                                    <button class="button button-small deactivate-bayi" data-bayi-id="<?php echo $bayi->id; ?>">PasifleÅŸtir</button>
                                <?php else: ?>
                                    <button class="button button-small activate-bayi" data-bayi-id="<?php echo $bayi->id; ?>">AktifleÅŸtir</button>
                                <?php endif; ?>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
        
        <!-- Yeni Bayi Modal -->
        <div id="bayi-modal" class="dastas-modal" style="display: none;">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Yeni Bayi Ekle</h2>
                <form id="bayi-form">
                    <table class="form-table">
                        <tr>
                            <th><label for="bayi_kodu">Bayi Kodu</label></th>
                            <td><input type="text" id="bayi_kodu" name="bayi_kodu" required></td>
                        </tr>
                        <tr>
                            <th><label for="bayi_adi">Bayi AdÄ±</label></th>
                            <td><input type="text" id="bayi_adi" name="bayi_adi" required></td>
                        </tr>
                        <tr>
                            <th><label for="kullanici_adi">KullanÄ±cÄ± AdÄ±</label></th>
                            <td><input type="text" id="kullanici_adi" name="kullanici_adi" required></td>
                        </tr>
                        <tr>
                            <th><label for="telefon">Telefon</label></th>
                            <td><input type="tel" id="telefon" name="telefon"></td>
                        </tr>
                        <tr>
                            <th><label for="eposta">E-posta</label></th>
                            <td><input type="email" id="eposta" name="eposta"></td>
                        </tr>
                        <tr>
                            <th><label for="sifre">Åifre</label></th>
                            <td><input type="password" id="sifre" name="sifre" required></td>
                        </tr>
                    </table>
                    <p class="submit">
                        <button type="submit" class="button button-primary">Kaydet</button>
                        <button type="button" class="button" onclick="document.getElementById('bayi-modal').style.display='none'">Ä°ptal</button>
                    </p>
                </form>
            </div>
        </div>
        <?php
    }
    
    public function renderNotificationsPage() {
        ?>
        <div class="wrap">
            <h1>Bildirimler
                <button class="page-title-action" id="send-notification">Bildirim GÃ¶nder</button>
            </h1>
            
            <div class="notification-stats">
                <div class="stat-item">
                    <span class="count">15</span>
                    <span class="label">GÃ¶nderilen</span>
                </div>
                <div class="stat-item">
                    <span class="count">8</span>
                    <span class="label">Okundu</span>
                </div>
                <div class="stat-item">
                    <span class="count">3</span>
                    <span class="label">Beklemede</span>
                </div>
            </div>
            
            <table class="wp-list-table widefat fixed striped">
                <thead>
                    <tr>
                        <th>BaÅŸlÄ±k</th>
                        <th>AlÄ±cÄ±</th>
                        <th>TÃ¼r</th>
                        <th>GÃ¶nderim Tarihi</th>
                        <th>Durum</th>
                        <th>Ä°ÅŸlemler</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Bildirimler buraya gelecek -->
                </tbody>
            </table>
        </div>
        <?php
    }
    
    public function renderSettingsPage() {
        ?>
        <div class="wrap">
            <h1>Dastas Bayi Sistemi AyarlarÄ±</h1>
            
            <form method="post" action="options.php">
                <?php
                settings_fields('dastas_settings');
                do_settings_sections('dastas_settings');
                ?>
                
                <table class="form-table">
                    <tr>
                        <th scope="row">Sistem Durumu</th>
                        <td>
                            <label>
                                <input type="checkbox" name="dastas_system_active" value="1" <?php checked(get_option('dastas_system_active', 1)); ?>>
                                Sistem aktif
                            </label>
                        </td>
                    </tr>
                    
                    <tr>
                        <th scope="row">Otomatik Onay</th>
                        <td>
                            <label>
                                <input type="checkbox" name="dastas_auto_approve" value="1" <?php checked(get_option('dastas_auto_approve', 0)); ?>>
                                SipariÅŸleri otomatik onayla
                            </label>
                        </td>
                    </tr>
                    
                    <tr>
                        <th scope="row">E-posta Bildirimleri</th>
                        <td>
                            <label>
                                <input type="checkbox" name="dastas_email_notifications" value="1" <?php checked(get_option('dastas_email_notifications', 1)); ?>>
                                E-posta bildirimlerini gÃ¶nder
                            </label>
                        </td>
                    </tr>
                    
                    <tr>
                        <th scope="row">Admin E-posta</th>
                        <td>
                            <input type="email" name="dastas_admin_email" value="<?php echo esc_attr(get_option('dastas_admin_email', get_option('admin_email'))); ?>" class="regular-text">
                        </td>
                    </tr>
                </table>
                
                <?php submit_button(); ?>
            </form>
        </div>
        <?php
    }
    
    private function getSystemStats() {
        global $wpdb;
        
        $bayi_table = $this->db->getTable('bayi');
        $siparis_table = $this->db->getTable('siparis');
        
        $stats = array();
        
        $stats['toplam_bayi'] = $wpdb->get_var("SELECT COUNT(*) FROM {$bayi_table}");
        $stats['aktif_bayi'] = $wpdb->get_var("SELECT COUNT(*) FROM {$bayi_table} WHERE aktif = 1");
        $stats['toplam_siparis'] = $wpdb->get_var("SELECT COUNT(DISTINCT siparis_no) FROM {$siparis_table}");
        $stats['bekleyen_siparis'] = $wpdb->get_var("SELECT COUNT(DISTINCT siparis_no) FROM {$siparis_table} WHERE durum = 'beklemede'");
        
        return $stats;
    }
    
    private function getOrders() {
        global $wpdb;
        
        $siparis_table = $this->db->getTable('siparis');
        $bayi_table = $this->db->getTable('bayi');
        
        return $wpdb->get_results("
            SELECT 
                s.id,
                s.siparis_no,
                s.siparis_tarihi,
                s.durum,
                b.bayi_adi,
                COUNT(s.id) as urun_sayisi,
                SUM(s.m3) as toplam_m3
            FROM {$siparis_table} s
            LEFT JOIN {$bayi_table} b ON s.bayi_id = b.id
            GROUP BY s.siparis_no
            ORDER BY s.siparis_tarihi DESC
            LIMIT 50
        ");
    }
    
    private function renderRecentOrders() {
        $orders = $this->getOrders();
        foreach (array_slice($orders, 0, 5) as $order) {
            echo '<div class="recent-order">';
            echo '<strong>' . esc_html($order->siparis_no) . '</strong> - ';
            echo esc_html($order->bayi_adi) . ' ';
            echo '<span class="order-date">' . date('d.m.Y', strtotime($order->siparis_tarihi)) . '</span>';
            echo '</div>';
        }
    }
    
    private function renderSystemStatus() {
        echo '<div class="status-item">';
        echo '<span class="status-label">Sistem:</span>';
        echo '<span class="status-value status-active">Aktif</span>';
        echo '</div>';

        echo '<div class="status-item">';
        echo '<span class="status-label">Database:</span>';
        echo '<span class="status-value status-active">BaÄŸlÄ±</span>';
        echo '</div>';

        echo '<div class="status-item">';
        echo '<span class="status-label">Plugin Versiyonu:</span>';
        echo '<span class="status-value">2.0.0</span>';
        echo '</div>';
    }

    private function getDetailedStats() {
        global $wpdb;

        $bayi_table = $this->db->getTable('bayi');
        $siparis_table = $this->db->getTable('siparis');

        // Bu ayki yeni bayiler
        $bu_ay_yeni_bayiler = $wpdb->get_var($wpdb->prepare("
            SELECT COUNT(*) FROM {$bayi_table}
            WHERE MONTH(olusturma_tarihi) = MONTH(CURRENT_DATE())
            AND YEAR(olusturma_tarihi) = YEAR(CURRENT_DATE())
        "));

        // GeÃ§en ayki bayi sayÄ±sÄ±
        $gecen_ay_bayi = $wpdb->get_var($wpdb->prepare("
            SELECT COUNT(*) FROM {$bayi_table}
            WHERE MONTH(olusturma_tarihi) = MONTH(DATE_SUB(CURRENT_DATE(), INTERVAL 1 MONTH))
            AND YEAR(olusturma_tarihi) = YEAR(DATE_SUB(CURRENT_DATE(), INTERVAL 1 MONTH))
        "));

        // Bayi artÄ±ÅŸ oranÄ±
        $bayi_artis_orani = $gecen_ay_bayi > 0 ?
            round((($bu_ay_yeni_bayiler - $gecen_ay_bayi) / $gecen_ay_bayi) * 100, 1) : 0;

        // Bu hafta tamamlanan sipariÅŸler
        $bu_hafta_tamamlanan = $wpdb->get_var($wpdb->prepare("
            SELECT COUNT(DISTINCT siparis_no) FROM {$siparis_table}
            WHERE durum = 'teslim-edildi'
            AND siparis_tarihi >= DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY)
        "));

        // BugÃ¼nkÃ¼ sipariÅŸler
        $bugunku_siparis = $wpdb->get_var($wpdb->prepare("
            SELECT COUNT(DISTINCT siparis_no) FROM {$siparis_table}
            WHERE DATE(siparis_tarihi) = CURRENT_DATE()
        "));

        // Toplam m3
        $toplam_m3 = $wpdb->get_var("SELECT SUM(m3) FROM {$siparis_table}");

        // Ortalama bekleme sÃ¼resi (gÃ¼n)
        $ortalama_bekleme = $wpdb->get_var("
            SELECT AVG(DATEDIFF(
                CASE
                    WHEN guncelleme_tarihi != olusturma_tarihi THEN guncelleme_tarihi
                    ELSE CURRENT_DATE()
                END,
                siparis_tarihi
            ))
            FROM {$siparis_table}
            WHERE durum = 'beklemede'
        ") ?: 0;

        // Tamamlanma oranÄ±
        $toplam_tamamlanan = $wpdb->get_var("SELECT COUNT(DISTINCT siparis_no) FROM {$siparis_table} WHERE durum = 'teslim-edildi'");
        $tamamlanma_orani = $toplam_tamamlanan > 0 ? round(($toplam_tamamlanan / $this->getSystemStats()['toplam_siparis']) * 100, 1) : 0;

        // Sistem saÄŸlÄ±k durumu
        $sistem_sagligi = $ortalama_bekleme < 7 ? 'excellent' : 'good';

        // Bekleyen sipariÅŸ Ã¶nceliÄŸi
        $bekleyen_oncelik = $ortalama_bekleme > 10 ? 'high' : 'normal';

        // AylÄ±k bÃ¼yÃ¼me (geÃ§en aya gÃ¶re)
        $bu_ay_siparis = $wpdb->get_var($wpdb->prepare("
            SELECT COUNT(DISTINCT siparis_no) FROM {$siparis_table}
            WHERE MONTH(siparis_tarihi) = MONTH(CURRENT_DATE())
            AND YEAR(siparis_tarihi) = YEAR(CURRENT_DATE())
        "));

        $gecen_ay_siparis = $wpdb->get_var($wpdb->prepare("
            SELECT COUNT(DISTINCT siparis_no) FROM {$siparis_table}
            WHERE MONTH(siparis_tarihi) = MONTH(DATE_SUB(CURRENT_DATE(), INTERVAL 1 MONTH))
            AND YEAR(siparis_tarihi) = YEAR(DATE_SUB(CURRENT_DATE(), INTERVAL 1 MONTH))
        "));

        $aylik_buyume = $gecen_ay_siparis > 0 ?
            round((($bu_ay_siparis - $gecen_ay_siparis) / $gecen_ay_siparis) * 100, 1) : 0;

        // Aktif kullanÄ±cÄ± oranÄ± (son 30 gÃ¼nde sipariÅŸ veren bayiler)
        $aktif_kullanici = $wpdb->get_var($wpdb->prepare("
            SELECT (COUNT(DISTINCT bayi_id) / (SELECT COUNT(*) FROM {$bayi_table} WHERE aktif = 1)) * 100
            FROM {$siparis_table}
            WHERE siparis_tarihi >= DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY)
        ")) ?: 0;

        // Sistem yÃ¼kÃ¼ (rastgele simÃ¼lasyon)
        $sistem_yuku = rand(15, 45);

        return [
            'bayi_artis_orani' => $bayi_artis_orani,
            'ortalama_bekleme' => round($ortalama_bekleme, 1),
            'bekleyen_oncelik' => $bekleyen_oncelik,
            'tamamlanan_siparis' => $bu_hafta_tamamlanan,
            'tamamlanma_orani' => $tamamlanma_orani,
            'bugunku_siparis' => $bugunku_siparis,
            'toplam_m3' => $toplam_m3,
            'sistem_sagligi' => $sistem_sagligi,
            'aylik_buyume' => $aylik_buyume,
            'aktif_kullanici' => round($aktif_kullanici, 1),
            'sistem_yuku' => $sistem_yuku,
            'ortalama_islem_suresi' => round($ortalama_bekleme, 1)
        ];
    }

    private function renderEnhancedRecentOrders() {
        $orders = $this->getOrders();
        $count = 0;

        foreach (array_slice($orders, 0, 5) as $order) {
            if ($count >= 5) break;

            $priority_class = '';
            $days_pending = floor((time() - strtotime($order->siparis_tarihi)) / (60*60*24));

            if ($days_pending > 7) {
                $priority_class = 'priority-high';
            } elseif ($days_pending > 3) {
                $priority_class = 'priority-medium';
            }

            echo '<div class="enhanced-order-item ' . $priority_class . '">';
            echo '<div class="order-header">';
            echo '<strong class="siparis-no-clickable" data-siparis-no="' . esc_attr($order->siparis_no) . '">' . esc_html($order->siparis_no) . '</strong>';
            echo '<span class="order-badge status-' . $order->durum . '">' . $this->getStatusText($order->durum) . '</span>';
            echo '</div>';
            echo '<div class="order-details">';
            echo '<span class="bayi-name">' . esc_html($order->bayi_adi) . '</span>';
            echo '<span class="order-date">' . date('d.m.Y H:i', strtotime($order->siparis_tarihi)) . '</span>';
            echo '</div>';
            echo '<div class="order-meta">';
            echo '<span class="urun-count">' . $order->urun_sayisi . ' Ã¼rÃ¼n</span>';
            echo '<span class="m3-total">' . number_format($order->toplam_m3, 1) . ' mÂ³</span>';
            echo '</div>';
            echo '</div>';

            $count++;
        }
    }

    private function renderDetailedSystemStatus() {
        $stats = $this->getDetailedStats();

        echo '<div class="status-grid">';
        echo '<div class="status-row">';
        echo '<span class="status-label">ğŸ–¥ï¸ Sunucu Durumu:</span>';
        echo '<span class="status-value status-excellent">MÃ¼kemmel</span>';
        echo '</div>';

        echo '<div class="status-row">';
        echo '<span class="status-label">ğŸ’¾ VeritabanÄ±:</span>';
        echo '<span class="status-value status-excellent">BaÄŸlÄ±</span>';
        echo '</div>';

        echo '<div class="status-row">';
        echo '<span class="status-label">ğŸ”’ GÃ¼venlik:</span>';
        echo '<span class="status-value status-excellent">GÃ¼venli</span>';
        echo '</div>';

        echo '<div class="status-row">';
        echo '<span class="status-label">âš¡ Performans:</span>';
        echo '<span class="status-value status-' . ($stats['sistem_yuku'] < 30 ? 'excellent' : 'good') . '">
            ' . $stats['sistem_yuku'] . '% yÃ¼k</span>';
        echo '</div>';

        echo '<div class="status-row">';
        echo '<span class="status-label">ğŸ“Š Bellek KullanÄ±mÄ±:</span>';
        echo '<span class="status-value status-good">Normal</span>';
        echo '</div>';

        echo '<div class="status-row">';
        echo '<span class="status-label">ğŸ”„ Son Yedekleme:</span>';
        echo '<span class="status-value">BugÃ¼n 03:00</span>';
        echo '</div>';
        echo '</div>';
    }

    private function getStatusText($status) {
        $statuses = [
            'beklemede' => 'Beklemede',
            'onaylandi' => 'OnaylandÄ±',
            'hazirlaniyor' => 'HazÄ±rlanÄ±yor',
            'sevk-edildi' => 'Sevk Edildi',
            'teslim-edildi' => 'Teslim Edildi',
            'iptal' => 'Ä°ptal'
        ];

        return $statuses[$status] ?? ucfirst($status);
    }
    
    // AJAX Handlers
    public function handleAdminAction() {
        check_ajax_referer('dastas_admin_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_die('Unauthorized');
        }
        
        $action = sanitize_text_field($_POST['admin_action']);
        
        switch ($action) {
            case 'add_bayi':
                $this->addNewBayi();
                break;
            case 'update_bayi':
                $this->updateBayi();
                break;
            case 'toggle_bayi_status':
                $this->toggleBayiStatus();
                break;
            default:
                wp_send_json_error('Invalid action');
        }
    }
    
    public function handleExportOrders() {
        check_ajax_referer('dastas_admin_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_die('Unauthorized');
        }
        
        // Excel export logic will be implemented here
        wp_send_json_success('Export started');
    }
    
    public function handleUpdateOrderStatus() {
        check_ajax_referer('dastas_admin_nonce', 'nonce');

        if (!current_user_can('manage_options')) {
            wp_die('Unauthorized');
        }

        $order_id = intval($_POST['order_id']);
        $new_status = sanitize_text_field($_POST['status']);

        global $wpdb;
        $siparis_table = $this->db->getTable('siparis');

        $result = $wpdb->update(
            $siparis_table,
            array('durum' => $new_status),
            array('id' => $order_id),
            array('%s'),
            array('%d')
        );

        if ($result !== false) {
            wp_send_json_success('Status updated');
        } else {
            wp_send_json_error('Update failed');
        }
    }

    public function handleGetAdminOrderDetails() {
        check_ajax_referer('dastas_admin_nonce', 'nonce');

        if (!current_user_can('manage_options')) {
            wp_die('Unauthorized');
        }

        $order_id = intval($_POST['order_id']);
        $siparis_no = sanitize_text_field($_POST['siparis_no']);

        global $wpdb;
        $siparis_table = $this->db->getTable('siparis');
        $bayi_table = $this->db->getTable('bayi');

        // SipariÅŸ detaylarÄ±nÄ± al
        $siparisler = $wpdb->get_results($wpdb->prepare("
            SELECT s.*, b.bayi_adi, b.bayi_kodu
            FROM {$siparis_table} s
            LEFT JOIN {$bayi_table} b ON s.bayi_id = b.id
            WHERE s.siparis_no = %s
            ORDER BY s.id
        ", $siparis_no));

        if (empty($siparisler)) {
            wp_send_json_error(['message' => 'SipariÅŸ bulunamadÄ±!']);
        }

        ob_start();
        ?>
        <div class="admin-siparis-detay-content">
            <div class="siparis-header-info">
                <h4>SipariÅŸ Bilgileri</h4>
                <div class="info-grid">
                    <div><strong>SipariÅŸ No:</strong> <?php echo esc_html($siparisler[0]->siparis_no); ?></div>
                    <div><strong>Bayi:</strong> <?php echo esc_html($siparisler[0]->bayi_adi . ' (' . $siparisler[0]->bayi_kodu . ')'); ?></div>
                    <div><strong>Tarih:</strong> <?php echo date('d.m.Y H:i', strtotime($siparisler[0]->siparis_tarihi)); ?></div>
                    <div><strong>Durum:</strong>
                        <span class="durum-badge durum-<?php echo esc_attr($siparisler[0]->durum); ?>">
                            <?php echo esc_html(ucfirst($siparisler[0]->durum)); ?>
                        </span>
                    </div>
                </div>
            </div>

            <div class="urunler-listesi">
                <h5>ÃœrÃ¼n DetaylarÄ±</h5>
                <?php foreach ($siparisler as $index => $urun): ?>
                    <div class="urun-detay-admin">
                        <h6>ÃœrÃ¼n <?php echo ($index + 1); ?></h6>
                        <div class="urun-info-grid">
                            <div><strong>AÄŸaÃ§ Cinsi:</strong> <?php echo esc_html($urun->agac_cinsi); ?></div>
                            <div><strong>KalÄ±nlÄ±k:</strong> <?php echo esc_html($urun->kalinlik); ?> mm</div>
                            <div><strong>Ebat:</strong> <?php echo esc_html($urun->ebat1 . ' x ' . $urun->ebat2); ?> cm</div>
                            <div><strong>Miktar:</strong> <?php echo esc_html($urun->miktar); ?> adet</div>
                            <div><strong>mÂ³:</strong> <?php echo esc_html(number_format($urun->m3, 3)); ?> mÂ³</div>
                            <div><strong>Tutkal:</strong> <?php echo esc_html($urun->tutkal); ?></div>
                            <?php if ($urun->kalite): ?>
                                <div><strong>Kalite:</strong> <?php echo esc_html($urun->kalite); ?></div>
                            <?php endif; ?>
                            <?php if ($urun->kaplama): ?>
                                <div><strong>Kaplama:</strong> <?php echo esc_html($urun->kaplama); ?></div>
                            <?php endif; ?>
                            <?php if ($urun->desen): ?>
                                <div><strong>Desen:</strong> <?php echo esc_html($urun->desen); ?></div>
                            <?php endif; ?>
                        </div>
                    </div>
                <?php endforeach; ?>
            </div>

            <div class="siparis-ozet">
                <h5>SipariÅŸ Ã–zeti</h5>
                <div class="ozet-grid">
                    <div><strong>Toplam ÃœrÃ¼n:</strong> <?php echo count($siparisler); ?> Ã¼rÃ¼n</div>
                    <div><strong>Toplam mÂ³:</strong> <?php echo number_format(array_sum(array_column($siparisler, 'm3')), 3); ?> mÂ³</div>
                    <div><strong>Ortalama mÂ³:</strong> <?php echo number_format(array_sum(array_column($siparisler, 'm3')) / count($siparisler), 3); ?> mÂ³</div>
                </div>
            </div>

            <?php if ($siparisler[0]->notlar): ?>
                <div class="siparis-notlari">
                    <h5>Notlar</h5>
                    <p><?php echo esc_html($siparisler[0]->notlar); ?></p>
                </div>
            <?php endif; ?>
        </div>
        <?php
        $html = ob_get_clean();

        wp_send_json_success(['html' => $html]);
    }
    
    private function addNewBayi() {
        $bayi_data = array(
            'bayi_kodu' => sanitize_text_field($_POST['bayi_kodu']),
            'bayi_adi' => sanitize_text_field($_POST['bayi_adi']),
            'kullanici_adi' => sanitize_text_field($_POST['kullanici_adi']),
            'telefon' => sanitize_text_field($_POST['telefon']),
            'eposta' => sanitize_email($_POST['eposta']),
            'sifre' => wp_hash_password($_POST['sifre']),
            'aktif' => 1
        );

        $result = $this->db->insertBayi($bayi_data);

        if ($result) {
            wp_send_json_success('Bayi baÅŸarÄ±yla eklendi');
        } else {
            wp_send_json_error('Bayi eklenirken hata oluÅŸtu');
        }
    }

    private function updateBayi() {
        $bayi_id = intval($_POST['bayi_id']);
        $bayi_data = array(
            'bayi_adi' => sanitize_text_field($_POST['bayi_adi']),
            'telefon' => sanitize_text_field($_POST['telefon']),
            'eposta' => sanitize_email($_POST['eposta'])
        );

        $result = $this->db->updateBayi($bayi_id, $bayi_data);

        if ($result !== false) {
            wp_send_json_success('Bayi baÅŸarÄ±yla gÃ¼ncellendi');
        } else {
            wp_send_json_error('Bayi gÃ¼ncellenirken hata oluÅŸtu');
        }
    }

    private function toggleBayiStatus() {
        $bayi_id = intval($_POST['bayi_id']);
        $current_bayi = $this->db->getBayiById($bayi_id);

        if (!$current_bayi) {
            wp_send_json_error('Bayi bulunamadÄ±');
            return;
        }

        $new_status = $current_bayi->aktif ? 0 : 1;
        $result = $this->db->updateBayi($bayi_id, array('aktif' => $new_status));

        if ($result !== false) {
            $status_text = $new_status ? 'aktifleÅŸtirildi' : 'pasifleÅŸtirildi';
            wp_send_json_success('Bayi baÅŸarÄ±yla ' . $status_text);
        } else {
            wp_send_json_error('Bayi durumu deÄŸiÅŸtirilirken hata oluÅŸtu');
        }
    }
}
